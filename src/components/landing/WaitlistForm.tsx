
"use client"

import { zodResolver } from "@hookform/resolvers/zod"
import { useForm } from "react-hook-form"
import * as z from "zod"
import React from 'react'
import emailjs from '@emailjs/browser';

import { Button } from "@/components/ui/button"
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form"
import { Input } from "@/components/ui/input"
import { Checkbox } from "@/components/ui/checkbox"
import { useToast } from "@/hooks/use-toast"
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "../ui/select"
import { ArrowRight, Loader2 } from "lucide-react"
import { Combobox } from "../ui/combobox"

const sources = [
    { id: "instagram", label: "Instagram" },
    { id: "tiktok", label: "TikTok" },
    { id: "friend", label: "Friend / Word of Mouth" },
    { id: "search", label: "Google Search" },
    { id: "other", label: "Other" },
]

const countryCodes = [
    { "value": "+971", "label": "ğŸ‡¦ğŸ‡ª United Arab Emirates" },
    { "value": "+93", "label": "ğŸ‡¦ğŸ‡« Afghanistan" },
    { "value": "+355", "label": "ğŸ‡¦ğŸ‡± Albania" },
    { "value": "+213", "label": "ğŸ‡©ğŸ‡¿ Algeria" },
    { "value": "+1-684", "label": "ğŸ‡¦ğŸ‡¸ American Samoa" },
    { "value": "+376", "label": "ğŸ‡¦ğŸ‡© Andorra" },
    { "value": "+244", "label": "ğŸ‡¦ğŸ‡´ Angola" },
    { "value": "+1-264", "label": "ğŸ‡¦ğŸ‡® Anguilla" },
    { "value": "+672", "label": "ğŸ‡¦ğŸ‡¶ Antarctica" },
    { "value": "+1-268", "label": "ğŸ‡¦ğŸ‡¬ Antigua and Barbuda" },
    { "value": "+54", "label": "ğŸ‡¦ğŸ‡· Argentina" },
    { "value": "+374", "label": "ğŸ‡¦ğŸ‡² Armenia" },
    { "value": "+297", "label": "ğŸ‡¦ğŸ‡¼ Aruba" },
    { "value": "+61", "label": "ğŸ‡¦ğŸ‡º Australia" },
    { "value": "+43", "label": "ğŸ‡¦ğŸ‡¹ Austria" },
    { "value": "+994", "label": "ğŸ‡¦ğŸ‡¿ Azerbaijan" },
    { "value": "+1-242", "label": "ğŸ‡§ğŸ‡¸ Bahamas" },
    { "value": "+973", "label": "ğŸ‡§ğŸ‡­ Bahrain" },
    { "value": "+880", "label": "ğŸ‡§ğŸ‡© Bangladesh" },
    { "value": "+1-246", "label": "ğŸ‡§ğŸ‡§ Barbados" },
    { "value": "+375", "label": "ğŸ‡§ğŸ‡¾ Belarus" },
    { "value": "+32", "label": "ğŸ‡§ğŸ‡ª Belgium" },
    { "value": "+501", "label": "ğŸ‡§ğŸ‡¿ Belize" },
    { "value": "+229", "label": "ğŸ‡§ğŸ‡¯ Benin" },
    { "value": "+1-441", "label": "ğŸ‡§ğŸ‡² Bermuda" },
    { "value": "+975", "label": "ğŸ‡§ğŸ‡¹ Bhutan" },
    { "value": "+591", "label": "ğŸ‡§ğŸ‡´ Bolivia" },
    { "value": "+387", "label": "ğŸ‡§ğŸ‡¦ Bosnia and Herzegovina" },
    { "value": "+267", "label": "ğŸ‡§ğŸ‡¼ Botswana" },
    { "value": "+55", "label": "ğŸ‡§ğŸ‡· Brazil" },
    { "value": "+246", "label": "ğŸ‡®ğŸ‡´ British Indian Ocean Territory" },
    { "value": "+1-284", "label": "ğŸ‡»ğŸ‡¬ British Virgin Islands" },
    { "value": "+673", "label": "ğŸ‡§ğŸ‡³ Brunei" },
    { "value": "+359", "label": "ğŸ‡§ğŸ‡¬ Bulgaria" },
    { "value": "+226", "label": "ğŸ‡§ğŸ‡« Burkina Faso" },
    { "value": "+257", "label": "ğŸ‡§ğŸ‡® Burundi" },
    { "value": "+855", "label": "ğŸ‡°ğŸ‡­ Cambodia" },
    { "value": "+237", "label": "ğŸ‡¨ğŸ‡² Cameroon" },
    { "value": "+1", "label": "ğŸ‡¨ğŸ‡¦ Canada" },
    { "value": "+238", "label": "ğŸ‡¨ğŸ‡» Cape Verde" },
    { "value": "+1-345", "label": "ğŸ‡°ğŸ‡¾ Cayman Islands" },
    { "value": "+236", "label": "ğŸ‡¨ğŸ‡« Central African Republic" },
    { "value": "+235", "label": "ğŸ‡¹ğŸ‡© Chad" },
    { "value": "+56", "label": "ğŸ‡¨ğŸ‡± Chile" },
    { "value": "+86", "label": "ğŸ‡¨ğŸ‡³ China" },
    { "value": "+61-8", "label": "ğŸ‡¨ğŸ‡½ Christmas Island" },
    { "value": "+61-8", "label": "ğŸ‡¨ğŸ‡¨ Cocos Islands" },
    { "value": "+57", "label": "ğŸ‡¨ğŸ‡´ Colombia" },
    { "value": "+269", "label": "ğŸ‡°ğŸ‡² Comoros" },
    { "value": "+682", "label": "ğŸ‡¨ğŸ‡° Cook Islands" },
    { "value": "+506", "label": "ğŸ‡¨ğŸ‡· Costa Rica" },
    { "value": "+385", "label": "ğŸ‡­ğŸ‡· Croatia" },
    { "value": "+53", "label": "ğŸ‡¨ğŸ‡º Cuba" },
    { "value": "+599", "label": "ğŸ‡¨ğŸ‡¼ Curacao" },
    { "value": "+357", "label": "ğŸ‡¨ğŸ‡¾ Cyprus" },
    { "value": "+420", "label": "ğŸ‡¨ğŸ‡¿ Czech Republic" },
    { "value": "+243", "label": "ğŸ‡¨ğŸ‡© Democratic Republic of the Congo" },
    { "value": "+45", "label": "ğŸ‡©ğŸ‡° Denmark" },
    { "value": "+253", "label": "ğŸ‡©ğŸ‡¯ Djibouti" },
    { "value": "+1-767", "label": "ğŸ‡©ğŸ‡² Dominica" },
    { "value": "+1-809", "label": "ğŸ‡©ğŸ‡´ Dominican Republic" },
    { "value": "+1-829", "label": "ğŸ‡©ğŸ‡´ Dominican Republic" },
    { "value": "+1-849", "label": "ğŸ‡©ğŸ‡´ Dominican Republic" },
    { "value": "+670", "label": "ğŸ‡¹ğŸ‡± East Timor" },
    { "value": "+593", "label": "ğŸ‡ªğŸ‡¨ Ecuador" },
    { "value": "+20", "label": "ğŸ‡ªğŸ‡¬ Egypt" },
    { "value": "+503", "label": "ğŸ‡¸ğŸ‡» El Salvador" },
    { "value": "+240", "label": "ğŸ‡¬ğŸ‡¶ Equatorial Guinea" },
    { "value": "+291", "label": "ğŸ‡ªğŸ‡· Eritrea" },
    { "value": "+372", "label": "ğŸ‡ªğŸ‡ª Estonia" },
    { "value": "+251", "label": "ğŸ‡ªğŸ‡¹ Ethiopia" },
    { "value": "+500", "label": "ğŸ‡«ğŸ‡° Falkland Islands" },
    { "value": "+298", "label": "ğŸ‡«ğŸ‡´ Faroe Islands" },
    { "value": "+679", "label": "ğŸ‡«ğŸ‡¯ Fiji" },
    { "value": "+358", "label": "ğŸ‡«ğŸ‡® Finland" },
    { "value": "+33", "label": "ğŸ‡«ğŸ‡· France" },
    { "value": "+594", "label": "ğŸ‡¬ğŸ‡« French Guiana" },
    { "value": "+689", "label": "ğŸ‡µğŸ‡« French Polynesia" },
    { "value": "+241", "label": "ğŸ‡¬ğŸ‡¦ Gabon" },
    { "value": "+220", "label": "ğŸ‡¬ğŸ‡² Gambia" },
    { "value": "+995", "label": "ğŸ‡¬ğŸ‡ª Georgia" },
    { "value": "+49", "label": "ğŸ‡©ğŸ‡ª Germany" },
    { "value": "+233", "label": "ğŸ‡¬ğŸ‡­ Ghana" },
    { "value": "+350", "label": "ğŸ‡¬ğŸ‡® Gibraltar" },
    { "value": "+30", "label": "ğŸ‡¬ğŸ‡· Greece" },
    { "value": "+299", "label": "ğŸ‡¬ğŸ‡± Greenland" },
    { "value": "+1-473", "label": "ğŸ‡¬ğŸ‡© Grenada" },
    { "value": "+590", "label": "ğŸ‡¬ğŸ‡µ Guadeloupe" },
    { "value": "+1-671", "label": "ğŸ‡¬ğŸ‡º Guam" },
    { "value": "+502", "label": "ğŸ‡¬ğŸ‡¹ Guatemala" },
    { "value": "+44-1481", "label": "ğŸ‡¬ğŸ‡¬ Guernsey" },
    { "value": "+224", "label": "ğŸ‡¬ğŸ‡³ Guinea" },
    { "value": "+245", "label": "ğŸ‡¬ğŸ‡¼ Guinea-Bissau" },
    { "value": "+592", "label": "ğŸ‡¬ğŸ‡¾ Guyana" },
    { "value": "+509", "label": "ğŸ‡­ğŸ‡¹ Haiti" },
    { "value": "+504", "label": "ğŸ‡­ğŸ‡³ Honduras" },
    { "value": "+852", "label": "ğŸ‡­ğŸ‡° Hong Kong" },
    { "value": "+36", "label": "ğŸ‡­ğŸ‡º Hungary" },
    { "value": "+354", "label": "ğŸ‡®ğŸ‡¸ Iceland" },
    { "value": "+91", "label": "ğŸ‡®ğŸ‡³ India" },
    { "value": "+62", "label": "ğŸ‡®ğŸ‡© Indonesia" },
    { "value": "+98", "label": "ğŸ‡®ğŸ‡· Iran" },
    { "value": "+964", "label": "ğŸ‡®ğŸ‡¶ Iraq" },
    { "value": "+353", "label": "ğŸ‡®ğŸ‡ª Ireland" },
    { "value": "+44-1624", "label": "ğŸ‡®ğŸ‡² Isle of Man" },
    { "value": "+972", "label": "ğŸ‡®ğŸ‡± Israel" },
    { "value": "+39", "label": "ğŸ‡®ğŸ‡¹ Italy" },
    { "value": "+225", "label": "ğŸ‡¨ğŸ‡® Ivory Coast" },
    { "value": "+1-876", "label": "ğŸ‡¯ğŸ‡² Jamaica" },
    { "value": "+81", "label": "ğŸ‡¯ğŸ‡µ Japan" },
    { "value": "+44-1534", "label": "ğŸ‡¯ğŸ‡ª Jersey" },
    { "value": "+962", "label": "ğŸ‡¯ğŸ‡´ Jordan" },
    { "value": "+7", "label": "ğŸ‡°ğŸ‡¿ Kazakhstan" },
    { "value": "+254", "label": "ğŸ‡°ğŸ‡ª Kenya" },
    { "value": "+686", "label": "ğŸ‡°ğŸ‡® Kiribati" },
    { "value": "+383", "label": "ğŸ‡½ğŸ‡° Kosovo" },
    { "value": "+965", "label": "ğŸ‡°ğŸ‡¼ Kuwait" },
    { "value": "+996", "label": "ğŸ‡°ğŸ‡¬ Kyrgyzstan" },
    { "value": "+856", "label": "ğŸ‡±ğŸ‡¦ Laos" },
    { "value": "+371", "label": "ğŸ‡±ğŸ‡» Latvia" },
    { "value": "+961", "label": "ğŸ‡±ğŸ‡§ Lebanon" },
    { "value": "+266", "label": "ğŸ‡±ğŸ‡¸ Lesotho" },
    { "value": "+231", "label": "ğŸ‡±ğŸ‡· Liberia" },
    { "value": "+218", "label": "ğŸ‡±ğŸ‡¾ Libya" },
    { "value": "+423", "label": "ğŸ‡±ğŸ‡® Liechtenstein" },
    { "value": "+370", "label": "ğŸ‡±ğŸ‡¹ Lithuania" },
    { "value": "+352", "label": "ğŸ‡±ğŸ‡º Luxembourg" },
    { "value": "+853", "label": "ğŸ‡²ğŸ‡´ Macau" },
    { "value": "+389", "label": "ğŸ‡²ğŸ‡° Macedonia" },
    { "value": "+261", "label": "ğŸ‡²ğŸ‡¬ Madagascar" },
    { "value": "+265", "label": "ğŸ‡²ğŸ‡¼ Malawi" },
    { "value": "+60", "label": "ğŸ‡²ğŸ‡¾ Malaysia" },
    { "value": "+960", "label": "ğŸ‡²ğŸ‡» Maldives" },
    { "value": "+223", "label": "ğŸ‡²ğŸ‡± Mali" },
    { "value": "+356", "label": "ğŸ‡²ğŸ‡¹ Malta" },
    { "value": "+692", "label": "ğŸ‡²ğŸ‡­ Marshall Islands" },
    { "value": "+596", "label": "ğŸ‡²ğŸ‡¶ Martinique" },
    { "value": "+222", "label": "ğŸ‡²ğŸ‡· Mauritania" },
    { "value": "+230", "label": "ğŸ‡²ğŸ‡º Mauritius" },
    { "value": "+262", "label": "ğŸ‡¾ğŸ‡¹ Mayotte" },
    { "value": "+52", "label": "ğŸ‡²ğŸ‡½ Mexico" },
    { "value": "+691", "label": "ğŸ‡«ğŸ‡² Micronesia" },
    { "value": "+373", "label": "ğŸ‡²ğŸ‡© Moldova" },
    { "value": "+377", "label": "ğŸ‡²ğŸ‡¨ Monaco" },
    { "value": "+976", "label": "ğŸ‡²ğŸ‡³ Mongolia" },
    { "value": "+382", "label": "ğŸ‡²ğŸ‡ª Montenegro" },
    { "value": "+1-664", "label": "ğŸ‡²ğŸ‡¸ Montserrat" },
    { "value": "+212", "label": "ğŸ‡²ğŸ‡¦ Morocco" },
    { "value": "+258", "label": "ğŸ‡²ğŸ‡¿ Mozambique" },
    { "value": "+95", "label": "ğŸ‡²ğŸ‡² Myanmar" },
    { "value": "+264", "label": "ğŸ‡³ğŸ‡¦ Namibia" },
    { "value": "+674", "label": "ğŸ‡³ğŸ‡· Nauru" },
    { "value": "+977", "label": "ğŸ‡³ğŸ‡µ Nepal" },
    { "value": "+31", "label": "ğŸ‡³ğŸ‡± Netherlands" },
    { "value": "+599", "label": "ğŸ‡§ğŸ‡¶ Netherlands Antilles" },
    { "value": "+687", "label": "ğŸ‡³ğŸ‡¨ New Caledonia" },
    { "value": "+64", "label": "ğŸ‡³ğŸ‡¿ New Zealand" },
    { "value": "+505", "label": "ğŸ‡³ğŸ‡® Nicaragua" },
    { "value": "+227", "label": "ğŸ‡³ğŸ‡ª Niger" },
    { "value": "+234", "label": "ğŸ‡³ğŸ‡¬ Nigeria" },
    { "value": "+683", "label": "ğŸ‡³ğŸ‡º Niue" },
    { "value": "+672-3", "label": "ğŸ‡³ğŸ‡« Norfolk Island" },
    { "value": "+850", "label": "ğŸ‡°ğŸ‡µ North Korea" },
    { "value": "+1-670", "label": "ğŸ‡²ğŸ‡µ Northern Mariana Islands" },
    { "value": "+47", "label": "ğŸ‡³ğŸ‡´ Norway" },
    { "value": "+968", "label": "ğŸ‡´ğŸ‡² Oman" },
    { "value": "+92", "label": "ğŸ‡µğŸ‡° Pakistan" },
    { "value": "+680", "label": "ğŸ‡µğŸ‡¼ Palau" },
    { "value": "+970", "label": "ğŸ‡µğŸ‡¸ Palestine" },
    { "value": "+507", "label": "ğŸ‡µğŸ‡¦ Panama" },
    { "value": "+675", "label": "ğŸ‡µğŸ‡¬ Papua New Guinea" },
    { "value": "+595", "label": "ğŸ‡µğŸ‡¾ Paraguay" },
    { "value": "+51", "label": "ğŸ‡µğŸ‡ª Peru" },
    { "value": "+63", "label": "ğŸ‡µğŸ‡­ Philippines" },
    { "value": "+64-9", "label": "ğŸ‡µğŸ‡³ Pitcairn" },
    { "value": "+48", "label": "ğŸ‡µğŸ‡± Poland" },
    { "value": "+351", "label": "ğŸ‡µğŸ‡¹ Portugal" },
    { "value": "+1-787", "label": "ğŸ‡µğŸ‡· Puerto Rico" },
    { "value": "+1-939", "label": "ğŸ‡µğŸ‡· Puerto Rico" },
    { "value": "+974", "label": "ğŸ‡¶ğŸ‡¦ Qatar" },
    { "value": "+242", "label": "ğŸ‡¨ğŸ‡¬ Republic of the Congo" },
    { "value": "+262", "label": "ğŸ‡·ğŸ‡ª Reunion" },
    { "value": "+40", "label": "ğŸ‡·ğŸ‡´ Romania" },
    { "value": "+7", "label": "ğŸ‡·ğŸ‡º Russia" },
    { "value": "+250", "label": "ğŸ‡·ğŸ‡¼ Rwanda" },
    { "value": "+590", "label": "ğŸ‡§ğŸ‡± Saint Barthelemy" },
    { "value": "+290", "label": "ğŸ‡¸ğŸ‡­ Saint Helena" },
    { "value": "+1-869", "label": "ğŸ‡°ğŸ‡³ Saint Kitts and Nevis" },
    { "value": "+1-758", "label": "ğŸ‡±ğŸ‡¨ Saint Lucia" },
    { "value": "+590-590", "label": "ğŸ‡²ğŸ‡« Saint Martin" },
    { "value": "+508", "label": "ğŸ‡µğŸ‡² Saint Pierre and Miquelon" },
    { "value": "+1-784", "label": "ğŸ‡»ğŸ‡¨ Saint Vincent and the Grenadines" },
    { "value": "+685", "label": "ğŸ‡¼ğŸ‡¸ Samoa" },
    { "value": "+378", "label": "ğŸ‡¸ğŸ‡² San Marino" },
    { "value": "+239", "label": "ğŸ‡¸ğŸ‡¹ Sao Tome and Principe" },
    { "value": "+966", "label": "ğŸ‡¸ğŸ‡¦ Saudi Arabia" },
    { "value": "+221", "label": "ğŸ‡¸ğŸ‡³ Senegal" },
    { "value": "+381", "label": "ğŸ‡·ğŸ‡¸ Serbia" },
    { "value": "+248", "label": "ğŸ‡¸ğŸ‡¨ Seychelles" },
    { "value": "+232", "label": "ğŸ‡¸ğŸ‡± Sierra Leone" },
    { "value": "+65", "label": "ğŸ‡¸ğŸ‡¬ Singapore" },
    { "value": "+1-721", "label": "ğŸ‡¸ğŸ‡½ Sint Maarten" },
    { "value": "+421", "label": "ğŸ‡¸ğŸ‡° Slovakia" },
    { "value": "+386", "label": "ğŸ‡¸ğŸ‡® Slovenia" },
    { "value": "+677", "label": "ğŸ‡¸ğŸ‡§ Solomon Islands" },
    { "value": "+252", "label": "ğŸ‡¸ğŸ‡´ Somalia" },
    { "value": "+27", "label": "ğŸ‡¿ğŸ‡¦ South Africa" },
    { "value": "+82", "label": "ğŸ‡°ğŸ‡· South Korea" },
    { "value": "+211", "label": "ğŸ‡¸ğŸ‡¸ South Sudan" },
    { "value": "+34", "label": "ğŸ‡ªğŸ‡¸ Spain" },
    { "value": "+94", "label": "ğŸ‡±ğŸ‡° Sri Lanka" },
    { "value": "+249", "label": "ğŸ‡¸ğŸ‡© Sudan" },
    { "value": "+597", "label": "ğŸ‡¸ğŸ‡· Suriname" },
    { "value": "+47-79", "label": "ğŸ‡¸ğŸ‡¯ Svalbard and Jan Mayen" },
    { "value": "+268", "label": "ğŸ‡¸ğŸ‡¿ Swaziland" },
    { "value": "+46", "label": "ğŸ‡¸ğŸ‡ª Sweden" },
    { "value": "+41", "label": "ğŸ‡¨ğŸ‡­ Switzerland" },
    { "value": "+963", "label": "ğŸ‡¸ğŸ‡¾ Syria" },
    { "value": "+886", "label": "ğŸ‡¹ğŸ‡¼ Taiwan" },
    { "value": "+992", "label": "ğŸ‡¹ğŸ‡¯ Tajikistan" },
    { "value": "+255", "label": "ğŸ‡¹ğŸ‡¿ Tanzania" },
    { "value": "+66", "label": "ğŸ‡¹ğŸ‡­ Thailand" },
    { "value": "+228", "label": "ğŸ‡¹ğŸ‡¬ Togo" },
    { "value": "+690", "label": "ğŸ‡¹ğŸ‡° Tokelau" },
    { "value": "+676", "label": "ğŸ‡¹ğŸ‡´ Tonga" },
    { "value": "+1-868", "label": "ğŸ‡¹ğŸ‡¹ Trinidad and Tobago" },
    { "value": "+216", "label": "ğŸ‡¹ğŸ‡³ Tunisia" },
    { "value": "+90", "label": "ğŸ‡¹ğŸ‡· Turkey" },
    { "value": "+993", "label": "ğŸ‡¹ğŸ‡² Turkmenistan" },
    { "value": "+1-649", "label": "ğŸ‡¹ğŸ‡¨ Turks and Caicos Islands" },
    { "value": "+688", "label": "ğŸ‡¹ğŸ‡» Tuvalu" },
    { "value": "+1-340", "label": "ğŸ‡»ğŸ‡® U.S. Virgin Islands" },
    { "value": "+256", "label": "ğŸ‡ºğŸ‡¬ Uganda" },
    { "value": "+380", "label": "ğŸ‡ºğŸ‡¦ Ukraine" },
    { "value": "+44", "label": "ğŸ‡¬ğŸ‡§ United Kingdom" },
    { "value": "+1", "label": "ğŸ‡ºğŸ‡¸ United States" },
    { "value": "+598", "label": "ğŸ‡ºğŸ‡¾ Uruguay" },
    { "value": "+998", "label": "ğŸ‡ºğŸ‡¿ Uzbekistan" },
    { "value": "+678", "label": "ğŸ‡»ğŸ‡º Vanuatu" },
    { "value": "+379", "label": "ğŸ‡»ğŸ‡¦ Vatican" },
    { "value": "+58", "label": "ğŸ‡»ğŸ‡ª Venezuela" },
    { "value": "+84", "label": "ğŸ‡»ğŸ‡³ Vietnam" },
    { "value": "+681", "label": "ğŸ‡¼ğŸ‡« Wallis and Futuna" },
    { "value": "+212", "label": "ğŸ‡ªğŸ‡­ Western Sahara" },
    { "value": "+967", "label": "ğŸ‡¾ğŸ‡ª Yemen" },
    { "value": "+260", "label": "ğŸ‡¿ğŸ‡² Zambia" },
    { "value": "+263", "label": "ğŸ‡¿ğŸ‡¼ Zimbabwe" }
].map(item => ({...item, id: `${item.label}-${item.value}`, fullLabel: `${item.label} (${item.value})`}));

const waitlistFormSchema = z.object({
  name: z.string().min(2, { message: "Name must be at least 2 characters." }).describe("The user's full name."),
  email: z.string().email({ message: "Please enter a valid email address." }).describe("The user's email address."),
  countryCode: z.string().describe("The user's phone country code."),
  phone: z.string().min(5, { message: "Please enter a valid phone number." }).describe("The user's phone number."),
  source: z.string({ required_error: "Please let us know how you found us."}).describe("How the user heard about TAVU."),
  consent: z.boolean().refine((value) => value === true, {
    message: "You must agree to receive TAVÃš emails and updates.",
  }).describe("Whether the user consented to receive emails."),
})

type WaitlistFormValues = z.infer<typeof waitlistFormSchema>

export default function WaitlistForm() {
  const { toast } = useToast()
  const [isSubmitting, setIsSubmitting] = React.useState(false)
  const formRef = React.useRef<HTMLFormElement>(null);

  const form = useForm<WaitlistFormValues>({
    resolver: zodResolver(waitlistFormSchema),
    defaultValues: {
      name: "",
      email: "",
      countryCode: "+971",
      phone: "",
      source: "",
      consent: false,
    },
  })

  // We need a separate handler for the form submission
  // that doesn't rely on react-hook-form's `data` object,
  // because emailjs.sendForm works directly with the form element.
  const handleFormSubmit = (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    
    // First, trigger validation from react-hook-form
    form.trigger().then((isValid) => {
        if (!isValid) {
            toast({
                variant: "destructive",
                title: "Please check the form.",
                description: "There are some errors in your submission.",
            });
            return;
        }

        // If valid, proceed with EmailJS
        setIsSubmitting(true);
        const serviceId = 'service_of1hcns';
        const templateId = 'template_3995qur';
        const publicKey = 'ChMo0khtrBlMBc2q1';

        if (!formRef.current) {
            console.error("EmailJS form ref is not available.");
            toast({
                variant: "destructive",
                title: "Uh oh! Something went wrong.",
                description: "Could not send the form. Please contact us directly.",
            });
            setIsSubmitting(false);
            return;
        }

        emailjs.sendForm(serviceId, templateId, formRef.current, publicKey)
          .then((response) => {
            console.log('SUCCESS!', response.status, response.text);
            toast({
              title: "You're on the list!",
              description: "Thank you for joining the TAVÃš waitlist. We'll be in touch soon.",
            });
            form.reset();
          })
          .catch((err) => {
            console.error('FAILED...', err);
            toast({
                variant: "destructive",
                title: "Uh oh! Something went wrong.",
                description: "There was a problem submitting your request. Please try again.",
            });
          })
          .finally(() => {
            setIsSubmitting(false);
          });
    });
  }

  return (
    <>
      <Card className="w-full max-w-2xl mx-auto shadow-2xl rounded-2xl bg-white/90 backdrop-blur-sm border-border/20">
        <CardHeader className="text-center pt-10 pb-4">
          <CardTitle className="text-4xl md:text-5xl font-body text-primary">Reserve Your Spot</CardTitle>
          <CardDescription className="text-xl font-body pt-2 text-muted-foreground max-w-lg mx-auto">
            Spots are limited. Moments are not. Be there when the doors open.
          </CardDescription>
        </CardHeader>
        <CardContent className="p-8">
          <Form {...form}>
            <form ref={formRef} onSubmit={handleFormSubmit} className="space-y-6">
               <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
                <FormField
                  control={form.control}
                  name="name"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel className="font-headline text-base text-primary">Full Name</FormLabel>
                      <FormControl>
                        <Input placeholder="Your full name" {...field} className="py-6 text-lg font-body bg-secondary/80 border-border/50 focus:bg-white"/>
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />
                <FormField
                  control={form.control}
                  name="email"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel className="font-headline text-base text-primary">Email Address</FormLabel>
                      <FormControl>
                        <Input type="email" placeholder="your@email.com" {...field} className="py-6 text-lg font-body bg-secondary/80 border-border/50 focus:bg-white"/>
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />
              </div>
              
              <FormItem>
                <FormLabel className="font-headline text-base text-primary">Phone Number</FormLabel>
                <div className="flex gap-2">
                    <FormField
                      control={form.control}
                      name="countryCode"
                      render={({ field }) => (
                          <FormItem className="w-2/3">
                               {/* This hidden input is for emailjs to grab the value */}
                              <input type="hidden" name="countryCode" value={field.value} />
                              <Combobox
                                  items={countryCodes}
                                  value={field.value}
                                  onChange={field.onChange}
                                  placeholder="Select country..."
                                  searchPlaceholder="Search country..."
                                  notFoundText="No country found."
                                  triggerClassName="py-6 text-lg font-body bg-secondary/80 border-border/50 focus:bg-white"
                              />
                              <FormMessage />
                          </FormItem>
                      )}
                    />
                    <FormField
                        control={form.control}
                        name="phone"
                        render={({ field }) => (
                        <FormItem className="w-full">
                            <FormControl>
                            <Input placeholder="55 555 5555" {...field} className="py-6 text-lg font-body bg-secondary/80 border-border/50 focus:bg-white"/>
                            </FormControl>
                            <FormMessage />
                        </FormItem>
                        )}
                    />
                </div>
              </FormItem>

              <FormField
                control={form.control}
                name="source"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel className="font-headline text-base text-primary">How did you hear about us?</FormLabel>
                    <Select onValueChange={field.onChange} defaultValue={field.value} name={field.name}>
                      <FormControl>
                        <SelectTrigger className="py-6 text-lg font-body bg-secondary/80 border-border/50 focus:bg-white">
                          <SelectValue placeholder="Select an option" />
                        </SelectTrigger>
                      </FormControl>
                      <SelectContent>
                        {sources.map(source => (
                          <SelectItem key={source.id} value={source.id}>{source.label}</SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                  control={form.control}
                  name="consent"
                  render={({ field }) => (
                    <FormItem className="flex flex-row items-start space-x-3 space-y-0 rounded-md p-4 bg-muted/70 border border-border/50">
                      <FormControl>
                        <Checkbox
                          checked={field.value}
                          onCheckedChange={field.onChange}
                          className="h-5 w-5 mt-1"
                          name={field.name}
                        />
                      </FormControl>
                      <div className="space-y-1 leading-none">
                        <FormLabel className="font-body text-base text-muted-foreground cursor-pointer">
                          I agree to receive TAVÃš emails and updates. I can unsubscribe at any time.
                        </FormLabel>
                        <FormMessage />
                      </div>
                    </FormItem>
                  )}
                />
              <Button type="submit" variant="destructive" className="w-full text-xl font-body py-7 rounded-full transition-transform duration-300 hover:scale-105" size="lg" disabled={isSubmitting}>
                  {isSubmitting ? (
                      <>
                          <Loader2 className="mr-2 h-5 w-5 animate-spin" />
                          Submitting...
                      </>
                  ) : (
                      <>
                          Claim My Spot
                          <ArrowRight className="ml-2 h-5 w-5"/>
                      </>
                  )}
              </Button>
            </form>
          </Form>
        </CardContent>
      </Card>
    </>
  )
}

    
